<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Festival Cívico 2025 — App de Encuestas (Anexo 6 y 7)</title>
<meta name="theme-color" content="#a78bfa" />
<style>
  :root{
    --bg:#0b0b12;
    --card:#161625;
    --muted:#a3a3b2;
    --text:#f1f1f7;
    --accent:#a78bfa;        /* lila */
    --accent-2:#c4b5fd;      /* lila claro */
    --ok:#10b981;
    --warn:#f59e0b;
    --bad:#ef4444;
    --border: #26263a;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Inter,Helvetica,Arial,sans-serif}
  .wrap{max-width:1000px;margin:20px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
  h1{font-size:1.25rem;margin:0}
  .tag{background:rgba(167,139,250,.15);color:#fff;border:1px solid var(--accent);padding:.25rem .5rem;border-radius:999px;font-size:.8rem}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 6px 16px rgba(0,0,0,.25)}
  .controls{display:flex;flex-wrap:wrap;gap:8px}
  button,.btn{appearance:none;border:none;background:var(--accent);color:#0b0b12;padding:.65rem .9rem;border-radius:12px;font-weight:600;cursor:pointer}
  button.ghost,.btn.ghost{background:transparent;border:1px solid var(--accent);color:#fff}
  button.flat{background:transparent;color:var(--text)}
  button:disabled{opacity:.6;cursor:not-allowed}
  select, input[type="number"], textarea{width:100%;background:#0f0f1b;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:.6rem}
  .radio-row{display:grid;grid-template-columns:1fr repeat(5, minmax(80px, 1fr));gap:8px;align-items:center}
  .radio-row .q{font-size:.95rem;color:#e9e9ff}
  .table-head{display:grid;grid-template-columns:1fr repeat(5, minmax(80px, 1fr));gap:8px;margin:.5rem 0;font-size:.85rem;color:var(--muted)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:820px){
    .grid{grid-template-columns:1fr}
    .radio-row,.table-head{grid-template-columns:1fr}
    .radio-row .scale{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .table-head{display:none}
  }
  .footer{color:var(--muted);font-size:.85rem;margin-top:24px}
  .pill{display:inline-block;padding:.2rem .5rem;border:1px solid var(--border);border-radius:999px;background:#101022;color:#bdbde0;font-size:.8rem}
  .success{border-color:#1e3a2f;background:rgba(16,185,129,.12)}
  .danger{border-color:#3a1e1e;background:rgba(239,68,68,.12)}
  .hint{color:var(--muted);font-size:.9rem}
  hr{border:none;border-top:1px solid var(--border);margin:16px 0}
  .brand{display:flex;align-items:center;gap:10px}
  .brand .logo{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),var(--accent-2));border-radius:10px}
  .brand strong{letter-spacing:.2px}
  .caption{font-size:.88rem;color:var(--muted)}
  .align-right{display:flex;justify-content:flex-end}
  .spacer{height:8px}
  .hide{display:none!important}
</style>
</head>
<body>
  <div class="wrap">
    <header class="card">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Festival Cívico 2025 — App de Encuestas</h1>
          <div class="caption">Responde <strong>Anexo 6</strong> (personas asistentes) y <strong>Anexo 7</strong> (personal de instituciones) desde el celular.</div>
        </div>
      </div>
      <span class="tag">Beta — local/offline</span>
    </header>

    <div class="card">
      <div class="controls">
        <button id="btn6">Encuesta de satisfacción — Anexo 6</button>
        <button id="btn7" class="ghost">Cuestionario para personal — Anexo 7</button>
        <button id="btnInfo" class="flat">Cómo exportar / compartir</button>
      </div>
      <div class="spacer"></div>
      <div class="hint">Sugerencia: genera dos códigos QR, uno para <span class="pill">?form=anexo6</span> y otro para <span class="pill">?form=anexo7</span>. Al escanear cada QR se abrirá el formulario correspondiente.</div>
    </div>

    <!-- Panel información -->
    <div id="panelInfo" class="card hide">
      <h3>Exportar y compartir respuestas</h3>
      <ol>
        <li>Las respuestas se guardan <strong>localmente</strong> en este dispositivo (navegador).</li>
        <li>Usa <em>Exportar CSV</em> para descargar un archivo por formulario o <em>Exportar todo</em> para un archivo consolidado.</li>
        <li>También puedes usar <em>Compartir</em> (si tu navegador lo permite) para enviar el CSV por correo, Drive, WhatsApp, etc.</li>
        <li>Para crear QR: publica esta página (por ejemplo en GitHub Pages) y genera un QR a la URL con <span class="pill">?form=anexo6</span> o <span class="pill">?form=anexo7</span>.</li>
      </ol>
    </div>

    <!-- Contenedor dinámico -->
    <div id="formContainer" class="card"></div>

    <!-- Acciones globales -->
    <div class="card">
      <div class="controls">
        <button id="btnExport6" class="ghost">Exportar CSV — Anexo 6</button>
        <button id="btnExport7" class="ghost">Exportar CSV — Anexo 7</button>
        <button id="btnExportAll">Exportar todo (CSV)</button>
        <button id="btnShare" class="ghost">Compartir último CSV</button>
        <button id="btnClear" class="ghost">Borrar todo (local)</button>
      </div>
      <div class="spacer"></div>
      <div class="hint">Privacidad: los datos no se envían a ningún servidor. Todo ocurre en tu navegador.</div>
    </div>

    <div class="footer">
      <div>Basado en los instrumentos: Anexo 6 (Encuesta de satisfacción) y Anexo 7 (Cuestionario para personal de instituciones participantes).</div>
      <div>Versión: <span id="version"></span></div>
    </div>
  </div>

<script>
// ======= Definición de formularios =======
const AGREEMENT = ["Completamente en desacuerdo","En desacuerdo","Ni de acuerdo ni en desacuerdo","De acuerdo","Completamente de acuerdo"];
const FREQUENCY = ["Nunca","Casi nunca","A veces","Casi siempre","Siempre"];

const anexo6 = {
  id: "anexo6",
  title: "Encuesta de satisfacción — Anexo 6",
  audience: "Personas asistentes",
  demographics: true,
  scale: AGREEMENT,
  statements: [
    "La información presentada fue útil.",
    "Los proyectos presentados fueron ilustrativos y acordes a las expectativas.",
    "Me sentí motivada(o) para participar en alguno de los proyectos ofrecidos por las instituciones participantes.",
    "Se fomentó la importancia de comprometerse con una causa entre las personas asistentes.",
    "Las actividades presentadas fomentan la participación de las personas para lograr atender problemas de mi interés.",
    "Las actividades presentadas resultan útiles para mi desarrollo profesional.",
    "Las dudas que me surgieron en torno a las actividades presentadas fueron resueltas conforme a mis expectativas.",
    "Las actividades artísticas presentadas cumplieron con mis expectativas.",
    "Las actividades artísticas estuvieron acorde a la temática del festival.",
    "El festival respondió a mis expectativas iniciales."
  ],
  openTextLabel: "Observaciones (opcional)"
};

const anexo7 = {
  id: "anexo7",
  title: "Cuestionario para personal — Anexo 7",
  audience: "Personal de instituciones participantes",
  demographics: true,
  scale: FREQUENCY,
  statements: [
    "Las personas asistentes demuestran atención y comprensión de la información proporcionada.",
    "Existe interés y participación activa por parte de las personas asistentes al Festival.",
    "Las personas asistentes demuestran interés por apoyar alguna de las acciones presentadas.",
    "Las personas asistentes demostraron empatía hacia la problemática presentada.",
    "Las personas asistentes solicitaron información para formar parte de alguno de los proyectos presentados.",
    "Las personas asistentes interactuaron aportando ideas y experiencias acordes al tema y basadas en sus contextos.",
    "Las personas asistentes identificaron problemáticas en su comunidad escolar.",
    "Las personas asistentes mantuvieron un ambiente respetuoso hacia las instituciones participantes y sus actividades.",
    "Las personas asistentes mostraron interés en aplicar algo de lo expuesto por las instituciones participantes en su entorno escolar."
  ],
  extra: true, // preguntas de voluntariado
  openTextLabel: "Observaciones, sugerencias y/o propuestas de mejora (opcional)"
};

const FORMS = { anexo6, anexo7 };

// ======= Utilidades =======
const storeKey = "festivalCivico2025_respuestas_v1";
const version = "1.0.0";

function getAll() {
  try { return JSON.parse(localStorage.getItem(storeKey)) || []; } catch(e){ return []; }
}
function setAll(arr) {
  localStorage.setItem(storeKey, JSON.stringify(arr));
}
function addResponse(payload) {
  const all = getAll();
  all.push(payload);
  setAll(all);
}
function nowISO() {
  return new Date().toISOString();
}
function toCSV(rows) {
  if (!rows.length) return "";
  const headers = Object.keys(rows[0]);
  const escape = v => {
    if (v == null) return "";
    const s = String(v).replace(/"/g,'""');
    return (/[",\n]/.test(s)) ? `"${s}"` : s;
  };
  const lines = [headers.join(",")].concat(rows.map(r => headers.map(h => escape(r[h])).join(",")));
  return lines.join("\n");
}
function download(name, text) {
  const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = name; a.click();
  setTimeout(()=> URL.revokeObjectURL(url), 1000);
  // Guarda último CSV para compartir
  window.__lastCSV = {name, text};
}
async function shareLastCSV(){
  if (!window.__lastCSV) { alert("Primero exporta un CSV."); return; }
  const {name, text} = window.__lastCSV;
  try{
    const blob = new Blob([text], {type:"text/csv"});
    const file = new File([blob], name, {type:"text/csv"});
    if (navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({files:[file], title:name, text:"Respuestas Festival Cívico 2025"});
    } else {
      // Copia el contenido si no se puede compartir
      await navigator.clipboard.writeText(text);
      alert("No se pudo compartir como archivo. El contenido del CSV se copió al portapapeles.");
    }
  }catch(e){
    alert("No fue posible compartir: " + e.message);
  }
}

// ======= Generación dinámica del formulario =======
function buildForm(cfg){
  const container = document.getElementById("formContainer");
  container.innerHTML = "";

  const h = (tag, attrs={}, children=[]) => {
    const el = document.createElement(tag);
    Object.entries(attrs).forEach(([k,v]) => {
      if (k === "class") el.className = v;
      else if (k === "for") el.htmlFor = v;
      else el.setAttribute(k, v);
    });
    children.forEach(c => {
      if (typeof c === "string") el.appendChild(document.createTextNode(c));
      else el.appendChild(c);
    });
    return el;
  };

  const form = h("form", {id:"theForm"});

  form.appendChild(h("h2", {}, [cfg.title]));
  form.appendChild(h("div", {class:"caption"}, ["Público objetivo: ", cfg.audience]));

  // Demográficos
  if (cfg.demographics){
    const dem = h("div", {class:"grid"});
    const edad = h("div", {}, [
      h("label", {for:"edad"}, ["Edad"]),
      h("input", {type:"number", id:"edad", name:"edad", min:"0", max:"120", placeholder:"años", required:"true"})
    ]);
    const genero = h("div", {}, [
      h("label", {}, ["Género"]),
      h("div", {role:"group","aria-label":"Género"}, [
        ...["Femenino","Masculino","Otro","Prefiero no decirlo"].map((opt,idx)=>{
          const id = "gen_"+idx;
          return h("label", {class:"pill", style:"margin-right:8px;cursor:pointer"}, [
            h("input", {type:"radio", name:"genero", id, value:opt, required:"true", style:"margin-right:6px"}),
            opt
          ]);
        })
      ])
    ]);
    dem.appendChild(edad);
    dem.appendChild(genero);
    form.appendChild(h("div", {class:"spacer"}));
    form.appendChild(dem);
  }

  // Tabla cabecera (en desktop)
  form.appendChild(h("div", {class:"table-head"}, [
    h("div", {}, ["Afirmación"]),
    ...cfg.scale.map(s=>h("div", {class:"th"}, [s]))
  ]));

  // Ítems
  cfg.statements.forEach((text, idx)=>{
    const row = h("div", {class:"radio-row"});
    row.appendChild(h("div", {class:"q"}, [(idx+1)+". "+text]));
    const scaleWrap = h("div", {class:"scale"});
    cfg.scale.forEach((label, valIdx)=>{
      const id = `${cfg.id}_q${idx}_o${valIdx}`;
      const inp = h("input", {type:"radio", name:`q_${idx}`, id, value:String(valIdx+1), required:"true"});
      const lab = h("label", {for:id}, [label]);
      const cell = h("div", {}, [inp, h("span", {style:"margin-left:6px"}, [label])]);
      if (window.matchMedia("(max-width:820px)").matches){
        scaleWrap.appendChild(cell);
      }else{
        // desktop: colocar cada input en su propia celda para alinear con cabecera
        row.appendChild(h("div", {}, [inp]));
      }
    });
    if (window.matchMedia("(max-width:820px)").matches){
      row.appendChild(scaleWrap);
    }
    form.appendChild(row);
  });

  // Campo abierto
  form.appendChild(h("div", {class:"spacer"}));
  form.appendChild(h("label", {for:"observ"}, [cfg.openTextLabel || "Observaciones (opcional)"]));
  form.appendChild(h("textarea", {id:"observ", rows:"4", placeholder:"Escribe aquí..."}));

  // Extra (voluntariado) para Anexo 7
  if (cfg.extra){
    form.appendChild(h("hr"));
    form.appendChild(h("h3", {}, ["Registro de voluntariado (si aplica)"]));

    // ¿Se contó con registro?
    const yesNo = (name, label) => {
      const wrap = h("div", {class:"grid"});
      wrap.appendChild(h("div", {}, [h("label", {}, [label])]));
      const radios = h("div", {}, [
        ...["Sí","No"].map((opt,idx)=>{
          const id = `${name}_${idx}`;
          return h("label", {class:"pill", style:"margin-right:8px;cursor:pointer"}, [
            h("input", {type:"radio", name, id, value:opt, required:"true", style:"margin-right:6px"}),
            opt
          ]);
        })
      ]);
      wrap.appendChild(radios);
      return wrap;
    };
    form.appendChild(yesNo("vol_registro","¿Se contó con registro de voluntariado?"));

    const y2 = yesNo("vol_alguien","¿Alguna persona se registró como voluntaria para alguna actividad o proyecto?");
    y2.id = "block_vol_alguien";
    form.appendChild(y2);

    const counts = h("div", {class:"grid", id:"block_counts"}, [
      h("div", {}, [h("label", {for:"vol_cuantas"}, ["¿Cuántas personas?"]), h("input",{type:"number", id:"vol_cuantas", min:"0", step:"1", placeholder:"0"})]),
      h("div", {}, [h("label", {for:"vol_m"}, ["Mujeres"]), h("input",{type:"number", id:"vol_m", min:"0", step:"1", placeholder:"0"})]),
      h("div", {}, [h("label", {for:"vol_h"}, ["Hombres"]), h("input",{type:"number", id:"vol_h", min:"0", step:"1", placeholder:"0"})]),
      h("div", {}, [h("label", {for:"vol_o"}, ["Otro"]), h("input",{type:"number", id:"vol_o", min:"0", step:"1", placeholder:"0"})])
    ]);
    form.appendChild(counts);

    // Lógica: si no hay registro, esconder lo demás
    form.addEventListener("change", (e)=>{
      if (e.target && e.target.name === "vol_registro"){
        const on = e.target.value === "Sí";
        document.getElementById("block_vol_alguien").classList.toggle("hide", !on);
        document.getElementById("block_counts").classList.toggle("hide", !on);
      }
      if (e.target && e.target.name === "vol_alguien"){
        const on = e.target.value === "Sí";
        document.getElementById("block_counts").classList.toggle("hide", !on);
      }
    });
    // Estado inicial
    document.getElementById("block_vol_alguien").classList.add("hide");
    document.getElementById("block_counts").classList.add("hide");
  }

  form.appendChild(h("div", {class:"spacer"}));
  form.appendChild(h("div", {class:"align-right"}, [
    h("button", {type:"submit"}, ["Guardar respuesta"])
  ]));

  form.addEventListener("submit", (ev)=>{
    ev.preventDefault();
    // Validación básica hecha por 'required'
    const edad = form.querySelector("#edad")?.value || "";
    const genero = form.querySelector("input[name='genero']:checked")?.value || "";
    const answers = cfg.statements.map((_,i)=>{
      const chosen = form.querySelector(`input[name='q_${i}']:checked`)?.value;
      const idx = chosen ? (parseInt(chosen,10)-1) : -1;
      return {
        value: chosen ? parseInt(chosen,10) : null,
        label: idx>=0 ? cfg.scale[idx] : ""
      };
    });

    const payload = {
      formId: cfg.id,
      formTitle: cfg.title,
      timestamp: nowISO(),
      edad,
      genero,
      observaciones: form.querySelector("#observ")?.value || "",
    };

    // Aplanar respuestas
    answers.forEach((a, i)=>{
      payload[`q${i+1}_num`] = a.value;
      payload[`q${i+1}_txt`] = a.label;
    });

    if (cfg.extra){
      const vr = form.querySelector("input[name='vol_registro']:checked")?.value || "";
      const va = form.querySelector("input[name='vol_alguien']:checked")?.value || "";
      payload["vol_registro"] = vr;
      payload["vol_alguien"] = va;
      if (vr === "Sí" && va === "Sí"){
        payload["vol_cuantas"] = form.querySelector("#vol_cuantas")?.value || "";
        payload["vol_m"] = form.querySelector("#vol_m")?.value || "";
        payload["vol_h"] = form.querySelector("#vol_h")?.value || "";
        payload["vol_o"] = form.querySelector("#vol_o")?.value || "";
      }
    }

    addResponse(payload);

    // Feedback
    const ok = document.createElement("div");
    ok.className = "card success";
    ok.textContent = "¡Respuesta guardada localmente! Puedes exportar el CSV cuando gustes.";
    container.insertBefore(ok, container.firstChild);
    setTimeout(()=> ok.remove(), 3500);
    form.reset();
    window.scrollTo({top:0, behavior:"smooth"});
  });

  container.appendChild(form);
}

// ======= Exportación CSV =======
function exportCSV(formId){
  const all = getAll();
  const rows = all.filter(r => r.formId === formId);
  if (!rows.length){ alert("No hay respuestas aún para este formulario."); return; }
  // Generar headers consistentes
  const sample = rows[0];
  const headers = Object.keys(sample);
  const csv = toCSV(rows);
  const fname = `respuestas_${formId}_${new Date().toISOString().slice(0,10)}.csv`;
  download(fname, csv);
}
function exportAll(){
  const all = getAll();
  if (!all.length){ alert("No hay respuestas aún."); return; }
  const csv = toCSV(all);
  const fname = `respuestas_consolidadas_${new Date().toISOString().slice(0,10)}.csv`;
  download(fname, csv);
}

// ======= UI Init =======
function setActive(btn){
  document.getElementById("btn6").classList.toggle("ghost", btn!=="anexo6");
  document.getElementById("btn7").classList.toggle("ghost", btn!=="anexo7");
}
function init(){
  document.getElementById("version").textContent = version;
  const params = new URLSearchParams(location.search);
  const which = params.get("form") || "anexo6";
  setActive(which);
  buildForm(FORMS[which] || anexo6);

  document.getElementById("btn6").addEventListener("click", ()=>{
    history.replaceState(null, "", "?form=anexo6");
    setActive("anexo6");
    buildForm(anexo6);
  });
  document.getElementById("btn7").addEventListener("click", ()=>{
    history.replaceState(null, "", "?form=anexo7");
    setActive("anexo7");
    buildForm(anexo7);
  });
  document.getElementById("btnExport6").addEventListener("click", ()=> exportCSV("anexo6"));
  document.getElementById("btnExport7").addEventListener("click", ()=> exportCSV("anexo7"));
  document.getElementById("btnExportAll").addEventListener("click", exportAll);
  document.getElementById("btnShare").addEventListener("click", shareLastCSV);
  document.getElementById("btnClear").addEventListener("click", ()=>{
    if (confirm("Esto borrará todas las respuestas guardadas en este dispositivo. ¿Continuar?")){
      localStorage.removeItem(storeKey);
      alert("Listo. Se borraron las respuestas locales.");
    }
  });
  document.getElementById("btnInfo").addEventListener("click", ()=>{
    document.getElementById("panelInfo").classList.toggle("hide");
  });
}
document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
